<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="u1mTB5JWczvR8aazOKgWjreaUB1ssIwuGy2FtZnfj68"><title> [Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기) · JingyuJung's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기) - Jingyu Jung"><meta name="keywords"><meta name="author" content="Jingyu Jung"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://monibu1548.github.io/atom.xml" title="JingyuJung's Blog"><script aync src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-1405208574064220",enable_page_level_ads: true})</script></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="POSTS" class="nav-list-link">POSTS</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="ARCHIVES" class="nav-list-link">ARCHIVES</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기)</h1><div class="post-info">2018-05-01<p class="visit"><i data-hk-page="current">-</i><span>읽음</span></p></div><div class="post-content"><h2 id="공공데이터-Open-API"><a href="#공공데이터-Open-API" class="headerlink" title="공공데이터 Open API"></a>공공데이터 Open API</h2><p><code>data.go.kr</code>에서 다양한 공공데이터 정보를 얻을 수 있습니다. 단순 데이터 파일 또는 Open API형태로 제공하고 있어서 이를 이용해 다양한 서비스를 구현할 수 있습니다.<br>지역 미세먼지 농도, 날씨 예보, 수질 정보 등등 정말 다양한 정보를 얻을 수 있는데요, 스터디용도로 이 API 중 하나를 선택해서 앱을 구현중입니다.</p>
<h2 id="지방선거-API-활용하기"><a href="#지방선거-API-활용하기" class="headerlink" title="지방선거 API 활용하기"></a>지방선거 API 활용하기</h2><p>가장 최신으로 등록된 API를 찾아보니 곧 6월 13일 지방선거를 앞두고 선거정보, 후보자 정보 Open API가 추가되어서 활용해보기로 했습니다.<br>역시 공공데이터 답게 Response API는 <code>XML</code>을 지원합니다.. 제발 <code>json</code>을 사용해주세요 ㅠㅜ</p>
<p><code>XML</code> 보다 <code>json</code>을 선호하는 이유는 다음과 같습니다.</p>
<ul>
<li><code>json</code>은 dict, list, string, number의 타입으로 구성되어 있죠. Objective-C 에서 사용하는 데이터 타입과 다르지 않아요. 그래서 json을 object로 매핑해주기 편합니다!</li>
<li><code>xml</code>은 list 타입이 없죠, 같은 depth에 동일한 태그가 여러개 구성되어 있는걸 list라고 판단해야 합니다. 우연히 해당 태그가 1개만 오면 이게 단순 key-value인지 list인지 알 방법이 없죠.</li>
</ul>
<h2 id="XML-파싱하기"><a href="#XML-파싱하기" class="headerlink" title="XML 파싱하기"></a>XML 파싱하기</h2><p>Objective-C 에서는 <code>NSXMLParser</code> 라는 클래스를 제공하여 쉽게 XML을 파싱할 수 있도록 도와주고 있습니다.<br>NSXMLParser로 XML을 파싱하는 순서는 다음과 같습니다.</p>
<ol>
<li>NSXMLParser에 파싱할 XML데이터 주입</li>
<li><code>parse</code> 메소드 호출</li>
<li>NSXMLParser의 델리게이트 호출 (문서 시작, 태그 시작, 태그 끝, 문서 종료 등..)</li>
</ol>
<h2 id="NSXMLParser-Delegate"><a href="#NSXMLParser-Delegate" class="headerlink" title="NSXMLParser Delegate"></a>NSXMLParser Delegate</h2><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parserDidStartDocument:(<span class="built_in">NSXMLParser</span> *)parser &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>XML 문서가 시작했음을 알리는 Delegate입니다. 처음 1회만 수행합니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser didStartElement:(<span class="built_in">NSString</span> *)elementName namespaceURI:(<span class="built_in">NSString</span> *)namespaceURI qualifiedName:(<span class="built_in">NSString</span> *)qName attributes:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="built_in">NSString</span> *&gt; *)attributeDict &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>&lt;태그&gt;</code> 를 발견했을 때 호출됩니다. elementName값으로 <code>태그</code>가 넘어옵니다.<br><code>&lt;태그 속성=값&gt;</code> 의 형식으로 된 XML태그의 경우 attributes dict 파라미터로 @{ @”속성”, @”값” } 이 전달됩니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser didEndElement:(<span class="built_in">NSString</span> *)elementName namespaceURI:(<span class="built_in">NSString</span> *)namespaceURI qualifiedName:(<span class="built_in">NSString</span> *)qName &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>&lt;/태그&gt;</code> 를 발견했을 때 호출됩니다. elementName 값으로 <code>태그</code>가 넘어옵니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser foundCharacters:(<span class="built_in">NSString</span> *)string &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>일반 문자열을 발견했을 때 호출됩니다.<br><code>&lt;태그&gt;안녕하세요&lt;/태그&gt;</code> 이 경우에 <code>didStartElement</code> 로 <code>태그</code> 값을 읽은 후 <code>foundCharacters</code> 메소드로 안, 녕, 하, 세, 요 가 한글자씩 전달됩니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parserDidEndDocument:(<span class="built_in">NSXMLParser</span> *)parser &#123;</span><br><span class="line">&#125;</span><br><span class="line">XML 문서가 끝났을 때 호출됩니다.</span><br></pre></td></tr></table></figure>
<ul>
<li>5개 Delegate 외에 파싱 에러 등 다른 메소드도 있지만 option으로 꼭 구현이 필요하진 않습니다</li>
</ul>
<h2 id="XML-Parsing-코드"><a href="#XML-Parsing-코드" class="headerlink" title="XML Parsing 코드"></a>XML Parsing 코드</h2><p>선거 정보 API 에서 내려오는 XML 예제는 다음과 같습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">response</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resultCode</span>&gt;</span>INFO-00<span class="tag">&lt;/<span class="name">resultCode</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resultMsg</span>&gt;</span>NORMAL SERVICE<span class="tag">&lt;/<span class="name">resultMsg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">items</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">num</span>&gt;</span>1<span class="tag">&lt;/<span class="name">num</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgId</span>&gt;</span>20180613<span class="tag">&lt;/<span class="name">sgId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgName</span>&gt;</span>제7회 전국동시지방선거<span class="tag">&lt;/<span class="name">sgName</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgTypecode</span>&gt;</span>0<span class="tag">&lt;/<span class="name">sgTypecode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgVotedate</span>&gt;</span>20180613<span class="tag">&lt;/<span class="name">sgVotedate</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">num</span>&gt;</span>2<span class="tag">&lt;/<span class="name">num</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgId</span>&gt;</span>220180613<span class="tag">&lt;/<span class="name">sgId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgName</span>&gt;</span>국회의원선거<span class="tag">&lt;/<span class="name">sgName</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgTypecode</span>&gt;</span>2<span class="tag">&lt;/<span class="name">sgTypecode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sgVotedate</span>&gt;</span>20180613<span class="tag">&lt;/<span class="name">sgVotedate</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">items</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">numOfRows</span>&gt;</span>10<span class="tag">&lt;/<span class="name">numOfRows</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pageNo</span>&gt;</span>1<span class="tag">&lt;/<span class="name">pageNo</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">totalCount</span>&gt;</span>10<span class="tag">&lt;/<span class="name">totalCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">response</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>중간에 <code>&lt;item&gt;</code> 이 엄청 많이 나오는데 list를 표현하기위해 2개만 남기고 나머지는 생략처리했습니다.</li>
</ul>
<p>위 XML에 매핑할 Object는 다음과 같이 작성했습니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  EHElectionSchedule.h</span></span><br><span class="line"><span class="comment">//  ElectionHelper</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by JingyuJung on 2018. 4. 29..</span></span><br><span class="line"><span class="comment">//  Copyright © 2018년 JingyuJung. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionSchedule</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSNumber</span> *sgId;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *sgName;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSNumber</span> *sgTypecode;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *sgVotedate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionSchedule_XMLArray</span> : <span class="title">NSMutableArray</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionScheduleResponseHeader</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *resultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionScheduleItems</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) EHElectionSchedule_XMLArray *item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionScheduleResponseBody</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) EHElectionScheduleItems *items;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionScheduleResponse</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) EHElectionScheduleResponseHeader *header;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) EHElectionScheduleResponseBody *body;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHElectionScheduleResponseContainer</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) EHElectionScheduleResponse *response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>클래스를 읽는 방향은 아래쪽부터 위로 읽어가면 됩니다.<br>규칙은 다음과 같습니다. </p>
<ul>
<li>클래스는 XML에서 1 Depth를 의미합니다.</li>
<li>프로퍼티명은 XML에서 tag 값과 일치해야 합니다.</li>
<li><code>Array Type</code> 을 표현할 경우 <code>{Array에 담길 클래스}{Array타입임을 알릴 Suffix}</code> 의 클래스를 추가적으로 선언해야 합니다. Suffix에 <code>_XMLArray</code>를 사용한 이유는 Parser코드에서 볼 수 있습니다.</li>
<li>프로퍼티의 클래스 타입은 Custom, NSString, NSNumber 입니다. (Primitive 타입 지원하지 않습니다.. 못합니다 ㅠㅜ)</li>
</ul>
<h2 id="XML-Parser"><a href="#XML-Parser" class="headerlink" title="XML Parser"></a>XML Parser</h2><p>우선 Full Code 입니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  EHXMLSerializer.m</span></span><br><span class="line"><span class="comment">//  ElectionHelper</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by JingyuJung on 2018. 4. 29..</span></span><br><span class="line"><span class="comment">//  Copyright © 2018년 JingyuJung. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"EHXMLSerializer.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHXMLSerializer</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSXMLParser</span> *parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="keyword">id</span>&gt; *keyStack;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableString</span> *value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Class wrapperClass;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> kEHXMLArraySuffix = <span class="string">@"_XMLArray"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">EHXMLSerializer</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Constructor</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">static</span> EHXMLSerializer *shared = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        shared = [[EHXMLSerializer alloc] init];</span><br><span class="line">        [shared EH_initializeXMLParser];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shared;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Public</span></span><br><span class="line">- (<span class="keyword">id</span>)modelWithXMLResponse:(<span class="built_in">NSURLResponse</span> *)response &#123;</span><br><span class="line">    [_parser parse];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Private</span></span><br><span class="line">- (<span class="keyword">void</span>)EH_initializeXMLParser &#123;</span><br><span class="line">    _parser = [[<span class="built_in">NSXMLParser</span> alloc] init];</span><br><span class="line">    _parser.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response data:(<span class="built_in">NSData</span> *)data error:(<span class="built_in">NSError</span> *__autoreleasing  _Nullable *)error &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *anError = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![_responseClass isSubclassOfClass:<span class="built_in">NSData</span>.class]) &#123;</span><br><span class="line">        <span class="built_in">NSXMLParser</span> *parser = [[<span class="built_in">NSXMLParser</span> alloc] initWithData:data];</span><br><span class="line">        <span class="keyword">if</span> (parser &amp;&amp; !anError) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_responseClass) &#123;</span><br><span class="line">                parser.delegate = <span class="keyword">self</span>;</span><br><span class="line">                [parser parse];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSXMLParserDelegate</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)parserDidStartDocument:(<span class="built_in">NSXMLParser</span> *)parser &#123;</span><br><span class="line">    _result = [[_responseClass alloc] init];</span><br><span class="line">    _keyStack = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    [_keyStack addObject:_result];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser didStartElement:(<span class="built_in">NSString</span> *)elementName namespaceURI:(<span class="built_in">NSString</span> *)namespaceURI qualifiedName:(<span class="built_in">NSString</span> *)qName attributes:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="built_in">NSString</span> *&gt; *)attributeDict &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSObject</span> *parentObject = _keyStack.lastObject;</span><br><span class="line">    Class propertyClass = [<span class="keyword">self</span> EH_classWithParentObject:parentObject propertyName:elementName];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (propertyClass) &#123;</span><br><span class="line">        <span class="keyword">id</span> childObject;</span><br><span class="line">        <span class="keyword">if</span> (propertyClass == [<span class="built_in">NSNumber</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">            <span class="comment">// NSNumber의 경우 init 제공 X =&gt; nil 방지처리</span></span><br><span class="line">            childObject = [[<span class="built_in">NSNumber</span> alloc] initWithInt:<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="built_in">NSStringFromClass</span>(propertyClass) hasSuffix:kEHXMLArraySuffix]) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *elementClassString = [<span class="built_in">NSStringFromClass</span>(propertyClass) stringByReplacingOccurrencesOfString:kEHXMLArraySuffix withString:<span class="string">@""</span>];</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *array = [parentObject valueForKey:elementName];</span><br><span class="line">            <span class="keyword">if</span> (![array isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                [_keyStack addObject:[<span class="built_in">NSMutableArray</span> array]];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [_keyStack addObject:array];</span><br><span class="line">            &#125;</span><br><span class="line">            propertyClass = <span class="built_in">NSClassFromString</span>(elementClassString);</span><br><span class="line">            childObject = [[propertyClass alloc] init];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            childObject = [[propertyClass alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        [_keyStack addObject:childObject];</span><br><span class="line">        _value = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser didEndElement:(<span class="built_in">NSString</span> *)elementName namespaceURI:(<span class="built_in">NSString</span> *)namespaceURI qualifiedName:(<span class="built_in">NSString</span> *)qName &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSObject</span> *parentObject = [_keyStack objectAtIndex:_keyStack.count - <span class="number">2</span>];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *wrapperArray;</span><br><span class="line">    <span class="built_in">BOOL</span> isArrayType = [parentObject isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]];</span><br><span class="line">    <span class="keyword">if</span> (isArrayType) &#123;</span><br><span class="line">        wrapperArray = (<span class="built_in">NSMutableArray</span> *)parentObject;</span><br><span class="line">        parentObject = [_keyStack objectAtIndex:_keyStack.count - <span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Class propertyClass = [<span class="keyword">self</span> EH_classWithParentObject:parentObject propertyName:elementName];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!propertyClass) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span> value = [_value length] ? _value : _keyStack.lastObject;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isArrayType) &#123;</span><br><span class="line">        [(<span class="built_in">NSMutableArray</span> *)wrapperArray addObject:_keyStack.lastObject];</span><br><span class="line">        [_keyStack removeLastObject];</span><br><span class="line">        value = wrapperArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [parentObject setValue:value forKey:elementName];</span><br><span class="line">    [_keyStack removeLastObject];</span><br><span class="line">    _value = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser foundCharacters:(<span class="built_in">NSString</span> *)string &#123;</span><br><span class="line">    [_value appendString:string];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)parserDidEndDocument:(<span class="built_in">NSXMLParser</span> *)parser &#123;</span><br><span class="line">    _result = _keyStack.firstObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)EH_classWithParentObject:(<span class="built_in">NSObject</span> *)object propertyName:(<span class="built_in">NSString</span> *)propertyName &#123;</span><br><span class="line">    </span><br><span class="line">    Class objectClass = object.class;</span><br><span class="line">    Class result;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> propertiesCount = <span class="number">0</span>;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList(objectClass, &amp;propertiesCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; propertiesCount; index++) &#123;</span><br><span class="line">        objc_property_t property = properties[index];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cname = property_getName(property);</span><br><span class="line">        <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithUTF8String:cname];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ([name isEqualToString:propertyName]) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *type = property_getAttributes(property);</span><br><span class="line">            <span class="built_in">NSString</span> *typeString = [<span class="built_in">NSString</span> stringWithUTF8String:type];</span><br><span class="line">            <span class="built_in">NSArray</span> *attributes = [typeString componentsSeparatedByString:<span class="string">@","</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *typeAttribute = [attributes objectAtIndex:<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *propertyType = [typeAttribute substringFromIndex:<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *propertyClass = [<span class="keyword">self</span> EH_removeNotNeededChar:propertyType];</span><br><span class="line"></span><br><span class="line">            result = <span class="built_in">NSClassFromString</span>(propertyClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(properties);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)EH_removeNotNeededChar:(<span class="built_in">NSString</span> *)originString &#123;</span><br><span class="line">    <span class="keyword">if</span> (originString.length &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([[originString substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">2</span>)] isEqualToString:<span class="string">@"@\""</span>] &amp;&amp;</span><br><span class="line">        [[originString substringWithRange:<span class="built_in">NSMakeRange</span>(originString.length - <span class="number">1</span>, <span class="number">1</span>)] isEqualToString:<span class="string">@"\""</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [originString substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">2</span>, originString.length - <span class="number">3</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>이제 구간별로 살펴보겠습니다.</p>
<ul>
<li>라인 : <code>13 - 23</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EHXMLSerializer</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSXMLParser</span> *parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="keyword">id</span>&gt; *keyStack;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableString</span> *value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Class wrapperClass;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>parser는 파싱을 수행할 parser<br>keyStack은 태그를 읽어나가면서 Depth를 관리하기 위한 Stack 입니다<br>value는 태그의 값을 관리하기 위한 MutableString 입니다<br>wrapperClass는 array 타입으로 된 부분을 파싱하기 위한 프로퍼티입니다<br>result는 최종 파싱 결과물이 될 프로퍼티입니다.</p>
<ul>
<li>라인 : <code>17 - 42</code></li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> kEHXMLArraySuffix = <span class="string">@"_XMLArray"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">EHXMLSerializer</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Constructor</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">static</span> EHXMLSerializer *shared = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        shared = [[EHXMLSerializer alloc] init];</span><br><span class="line">        [shared EH_initializeXMLParser];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shared;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@&quot;_XMLArray&quot;</code> 는 해당 클래스가 XML을 파싱할 때 Array 타입으로 해야한다는 걸 알리기 위해 Model 작성할 때 명시적으로 붙였던 Suffix 입니다.<br><code>serialilzer</code> 는 GCD를 이용해 싱글톤으로 구현한 생성자입니다.</p>
<ul>
<li>라인 : <code>56 - 69</code></li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response data:(<span class="built_in">NSData</span> *)data error:(<span class="built_in">NSError</span> *__autoreleasing  _Nullable *)error &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *anError = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![_responseClass isSubclassOfClass:<span class="built_in">NSData</span>.class]) &#123;</span><br><span class="line">        <span class="built_in">NSXMLParser</span> *parser = [[<span class="built_in">NSXMLParser</span> alloc] initWithData:data];</span><br><span class="line">        <span class="keyword">if</span> (parser &amp;&amp; !anError) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_responseClass) &#123;</span><br><span class="line">                parser.delegate = <span class="keyword">self</span>;</span><br><span class="line">                [parser parse];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>response 로 받아온 XML Data를 이용해서 외부에서 호출하는 메소드입니다.<br>외부에서 이 메소드를 호출하기 전에 <code>responseClass</code>에 이 XML에 매핑할 클래스를 <code>set</code> 해주는 과정이 꼬오옥 필요합니다.</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[[EHXMLSerializer serializer] setResponseClass:[EHElectionScheduleResponseContainer <span class="keyword">class</span>]];</span><br><span class="line">        EHElectionScheduleResponseContainer *container = [[EHXMLSerializer serializer] responseObjectForResponse:response data:responseObject error:&amp;error];</span><br></pre></td></tr></table></figure>
<p>API 호출을 완료한 후 Model에 Mapping 하기 위해 Parser호출하는 부분</p>
<p><code>[parser parse]</code>에 의해 파싱이 시작됩니다.</p>
<ul>
<li>라인 : <code>73 - 77</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parserDidStartDocument:(<span class="built_in">NSXMLParser</span> *)parser &#123;</span><br><span class="line">    _result = [[_responseClass alloc] init];</span><br><span class="line">    _keyStack = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    [_keyStack addObject:_result];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>XML 문서 파싱을 시작할 때 호출됩니다. 파싱에 필요한 프로퍼티들을 초기화합니다. 가장 첫번째 Response 객체를 keyStack에 담는것으로 파싱을 시작합니다.</p>
<ul>
<li>라인 : <code>79 - 105</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser didStartElement:(<span class="built_in">NSString</span> *)elementName namespaceURI:(<span class="built_in">NSString</span> *)namespaceURI qualifiedName:(<span class="built_in">NSString</span> *)qName attributes:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="built_in">NSString</span> *&gt; *)attributeDict &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSObject</span> *parentObject = _keyStack.lastObject;</span><br><span class="line">    Class propertyClass = [<span class="keyword">self</span> EH_classWithParentObject:parentObject propertyName:elementName];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (propertyClass) &#123;</span><br><span class="line">        <span class="keyword">id</span> childObject;</span><br><span class="line">        <span class="keyword">if</span> (propertyClass == [<span class="built_in">NSNumber</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">            childObject = [[<span class="built_in">NSNumber</span> alloc] initWithInt:<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="built_in">NSStringFromClass</span>(propertyClass) hasSuffix:kEHXMLArraySuffix]) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *elementClassString = [<span class="built_in">NSStringFromClass</span>(propertyClass) stringByReplacingOccurrencesOfString:kEHXMLArraySuffix withString:<span class="string">@""</span>];</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *array = [parentObject valueForKey:elementName];</span><br><span class="line">            <span class="keyword">if</span> (![array isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                [_keyStack addObject:[<span class="built_in">NSMutableArray</span> array]];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [_keyStack addObject:array];</span><br><span class="line">            &#125;</span><br><span class="line">            propertyClass = <span class="built_in">NSClassFromString</span>(elementClassString);</span><br><span class="line">            childObject = [[propertyClass alloc] init];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            childObject = [[propertyClass alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        [_keyStack addObject:childObject];</span><br><span class="line">        _value = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>XML 에서 태그를 발견하면 keyStack의 lastObject (1 depth 상위 클래스) 에 포함된 프로퍼티인지 확인합니다. 없다면 굳이 매핑이 필요없으므로 패스!<br>포함되어있다면 해당 프로퍼티의 클래스를 판별하고 할당하여 keyStack에 담아둡니다. <code>_value</code> NSMutableString 을 할당하여 값을 읽을 준비를 합니다.</p>
<ul>
<li>라인 : <code>136 - 138</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser foundCharacters:(<span class="built_in">NSString</span> *)string &#123;</span><br><span class="line">    [_value appendString:string];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>태그 사이의 값들을 <code>_value</code> 에  appending해 나가면서 값을 완성시켜 나갑니다.</p>
<ul>
<li>라인 : <code>107 - 134</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parser:(<span class="built_in">NSXMLParser</span> *)parser didEndElement:(<span class="built_in">NSString</span> *)elementName namespaceURI:(<span class="built_in">NSString</span> *)namespaceURI qualifiedName:(<span class="built_in">NSString</span> *)qName &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSObject</span> *parentObject = [_keyStack objectAtIndex:_keyStack.count - <span class="number">2</span>];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *wrapperArray;</span><br><span class="line">    <span class="built_in">BOOL</span> isArrayType = [parentObject isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]];</span><br><span class="line">    <span class="keyword">if</span> (isArrayType) &#123;</span><br><span class="line">        wrapperArray = (<span class="built_in">NSMutableArray</span> *)parentObject;</span><br><span class="line">        parentObject = [_keyStack objectAtIndex:_keyStack.count - <span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Class propertyClass = [<span class="keyword">self</span> EH_classWithParentObject:parentObject propertyName:elementName];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!propertyClass) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span> value = [_value length] ? _value : _keyStack.lastObject;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isArrayType) &#123;</span><br><span class="line">        [(<span class="built_in">NSMutableArray</span> *)wrapperArray addObject:_keyStack.lastObject];</span><br><span class="line">        [_keyStack removeLastObject];</span><br><span class="line">        value = wrapperArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [parentObject setValue:value forKey:elementName];</span><br><span class="line">    [_keyStack removeLastObject];</span><br><span class="line">    _value = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>태그가 끝나면 keyStack의 마지막 object에 값을 KVC로 셋하고 _keyStack에서 완성된 lastObject를 제거합니다.<br>만약 부모클래스가 Array 타입이었다면 현재 완성된 클래스를 Array에 추가시켜줍니다.</p>
<ul>
<li>라인 : <code>140 - 142</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)parserDidEndDocument:(<span class="built_in">NSXMLParser</span> *)parser &#123;</span><br><span class="line">    _result = _keyStack.firstObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>XML 문서가 끝나면 최종적으로 keyStack에는 최상위 클래스가 남게됩니다. 따라서 result에 _keyStack의 firstObject를 연결합니다.</p>
<ul>
<li>라인 : <code>144 - 172</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (Class)EH_classWithParentObject:(<span class="built_in">NSObject</span> *)object propertyName:(<span class="built_in">NSString</span> *)propertyName &#123;</span><br><span class="line">    </span><br><span class="line">    Class objectClass = object.class;</span><br><span class="line">    Class result;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> propertiesCount = <span class="number">0</span>;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList(objectClass, &amp;propertiesCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; propertiesCount; index++) &#123;</span><br><span class="line">        objc_property_t property = properties[index];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cname = property_getName(property);</span><br><span class="line">        <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithUTF8String:cname];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ([name isEqualToString:propertyName]) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *type = property_getAttributes(property);</span><br><span class="line">            <span class="built_in">NSString</span> *typeString = [<span class="built_in">NSString</span> stringWithUTF8String:type];</span><br><span class="line">            <span class="built_in">NSArray</span> *attributes = [typeString componentsSeparatedByString:<span class="string">@","</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *typeAttribute = [attributes objectAtIndex:<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *propertyType = [typeAttribute substringFromIndex:<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">NSString</span> *propertyClass = [<span class="keyword">self</span> EH_removeNotNeededChar:propertyType];</span><br><span class="line"></span><br><span class="line">            result = <span class="built_in">NSClassFromString</span>(propertyClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(properties);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>해당 obejct에 propertyName이라는 변수명을 가진 프로퍼티의 클래스를 리턴해주는 함수입니다.<br>Objective-C의 인스트로펙션, 자바에서 리플렉션이라 불리는 기능을 이용해 구현합니다.</p>
<ul>
<li>라인 : <code>174 - 183</code><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)EH_removeNotNeededChar:(<span class="built_in">NSString</span> *)originString &#123;</span><br><span class="line">    <span class="keyword">if</span> (originString.length &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([[originString substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">2</span>)] isEqualToString:<span class="string">@"@\""</span>] &amp;&amp;</span><br><span class="line">        [[originString substringWithRange:<span class="built_in">NSMakeRange</span>(originString.length - <span class="number">1</span>, <span class="number">1</span>)] isEqualToString:<span class="string">@"\""</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [originString substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">2</span>, originString.length - <span class="number">3</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>runtime 메소드를 이용해 property의 클래스 타입을 가져왔을 때, @\”\” 의 불필요한 문자열이 추가되기 때문에 제거를 위해 만든 함수입니다.</p>
<h2 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h2><p>위에서 만든 XMl Serializer를 이용해 XML을 매핑하면 다음과 같은 결과를 얻을 수 있습니다.<br><img src="../../../../images/xmlparser/1.png" alt=""></p>
<p><code>더 보완이 필요한 내용</code></p>
<ul>
<li>현재 최종 마지막 타입은 <code>NSString</code> 과 <code>NSNumber</code> 만 지원하고 있는데, <code>NSDate</code> 도 추가가 필요합니다!</li>
</ul>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>카테고리</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ETC/">ETC</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NHN-ent/">NHN ent.</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Framework/">Spring Framework</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Etc/">Etc</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Objective-C/">Objective-C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Swift/">Swift</a><span class="category-list-count">1</span></li></ul></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>태그</h4><a href="/tags/Admob/" style="font-size: 10px;">Admob</a> <a href="/tags/Apple/" style="font-size: 12.5px;">Apple</a> <a href="/tags/CI/" style="font-size: 10px;">CI</a> <a href="/tags/CocoaPods/" style="font-size: 12.5px;">CocoaPods</a> <a href="/tags/Dooray/" style="font-size: 10px;">Dooray</a> <a href="/tags/GCD/" style="font-size: 10px;">GCD</a> <a href="/tags/Interface-Builder/" style="font-size: 10px;">Interface Builder</a> <a href="/tags/Jasypt/" style="font-size: 10px;">Jasypt</a> <a href="/tags/NHN/" style="font-size: 12.5px;">NHN</a> <a href="/tags/NSXMLParser/" style="font-size: 10px;">NSXMLParser</a> <a href="/tags/Reflection/" style="font-size: 12.5px;">Reflection</a> <a href="/tags/Runtime/" style="font-size: 10px;">Runtime</a> <a href="/tags/Spring-Framework/" style="font-size: 17.5px;">Spring Framework</a> <a href="/tags/Storyboard/" style="font-size: 10px;">Storyboard</a> <a href="/tags/Swift/" style="font-size: 10px;">Swift</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/XCode/" style="font-size: 10px;">XCode</a> <a href="/tags/XCodeServer/" style="font-size: 10px;">XCodeServer</a> <a href="/tags/XML-Parser/" style="font-size: 10px;">XML Parser</a> <a href="/tags/Xcode/" style="font-size: 12.5px;">Xcode</a> <a href="/tags/grafana/" style="font-size: 10px;">grafana</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/influxDB/" style="font-size: 10px;">influxDB</a> <a href="/tags/java/" style="font-size: 12.5px;">java</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/기술교육/" style="font-size: 10px;">기술교육</a> <a href="/tags/모니터링/" style="font-size: 10px;">모니터링</a> <a href="/tags/배포/" style="font-size: 10px;">배포</a> <a href="/tags/버전-관리/" style="font-size: 10px;">버전 관리</a> <a href="/tags/생산성/" style="font-size: 10px;">생산성</a> <a href="/tags/성능-튜닝/" style="font-size: 10px;">성능 튜닝</a> <a href="/tags/스위프트/" style="font-size: 10px;">스위프트</a> <a href="/tags/스터디/" style="font-size: 10px;">스터디</a> <a href="/tags/스프링-프레임워크/" style="font-size: 17.5px;">스프링 프레임워크</a> <a href="/tags/애드몹/" style="font-size: 10px;">애드몹</a> <a href="/tags/웹/" style="font-size: 15px;">웹</a> <a href="/tags/최적화/" style="font-size: 12.5px;">최적화</a> <a href="/tags/쿼리스트링/" style="font-size: 10px;">쿼리스트링</a> <a href="/tags/토스트루키/" style="font-size: 10px;">토스트루키</a></div></div><div class="widget"><div class="recent"><h4>최근 포스트</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/ios-admob/">iOS 앱에서 광고 수익 얻기 (Admob 애드몹 설치, 부착)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/03/iboutlet-strong-weak/">Interface Builder IBOutlet연결에 Strong과 Weak 어떤것을 써야할까?</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/01/xml-mapper/">[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/01/objc-runtime/">[Objective-C] reflection(리플렉션), Introspection(인트로스펙션) Runtime 메소드 사용하기</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/25/xcode-server-intro/">XCode Server를 이용한 CI(continuous integration)</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">검색</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/05/03/iboutlet-strong-weak/" class="prev">PREV</a><a href="/2018/05/01/objc-runtime/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'jingyujung';
var disqus_identifier = '2018/05/01/xml-mapper/';
var disqus_title = '[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기)';
var disqus_url = 'http://monibu1548.github.io/2018/05/01/xml-mapper/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//jingyujung.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2018 <a target="_blank">Jingyu Jung</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-117570529-1",'auto');ga('send','pageview');</script></body></html>