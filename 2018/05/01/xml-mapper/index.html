
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기) - JingyuJung&#39;s Blog</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="공공데이터 Open APIdata.go.kr에서 다양한 공공데이터 정보를 얻을 수 있습니다. 단순 데이터 파일 또는 Open API형태로 제공하고 있어서 이를 이용해 다양한 서비,"> 
    <meta name="author" content="Jingyu Jung"> 
    <link rel="alternative" href="atom.xml" title="JingyuJung&#39;s Blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="/css/obsidian.css">
    <link rel="stylesheet" href="/css/ball-atom.min.css">
</head>

<script data-ad-client="ca-pub-1405208574064220" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">JingyuJung&#39;s Blog</span>
    <div id="loader"></div>
    <script data-ad-client="ca-pub-1405208574064220" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="http://monibu1548.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기)</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="douban,diandian,tencent"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg);">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="/categories/iOS"><b>「
                    </b>IOS<b> 」</b></a>
                
                May 01, 2018
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/2018/05/01/xml-mapper/" title="[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기)">[Objective-C] NSXMLParser로 XML Object Mapper 구현하기 (공공데이터 Response 파싱하기)</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    21k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    19 mins.
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/NSXMLParser/">NSXMLParser</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/Reflection/">Reflection</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/XML-Parser/">XML Parser</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/iOS/">iOS</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/스터디/">스터디</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h2 id="공공데이터-Open-API"><a href="#공공데이터-Open-API" class="headerlink" title="공공데이터 Open API"></a>공공데이터 Open API</h2><p><code>data.go.kr</code>에서 다양한 공공데이터 정보를 얻을 수 있습니다. 단순 데이터 파일 또는 Open API형태로 제공하고 있어서 이를 이용해 다양한 서비스를 구현할 수 있습니다.<br>지역 미세먼지 농도, 날씨 예보, 수질 정보 등등 정말 다양한 정보를 얻을 수 있는데요, 스터디용도로 이 API 중 하나를 선택해서 앱을 구현중입니다.</p>
<h2 id="지방선거-API-활용하기"><a href="#지방선거-API-활용하기" class="headerlink" title="지방선거 API 활용하기"></a>지방선거 API 활용하기</h2><p>가장 최신으로 등록된 API를 찾아보니 곧 6월 13일 지방선거를 앞두고 선거정보, 후보자 정보 Open API가 추가되어서 활용해보기로 했습니다.<br>역시 공공데이터 답게 Response API는 <code>XML</code>을 지원합니다.. 제발 <code>json</code>을 사용해주세요 ㅠㅜ</p>
<p><code>XML</code> 보다 <code>json</code>을 선호하는 이유는 다음과 같습니다.</p>
<ul>
<li><code>json</code>은 dict, list, string, number의 타입으로 구성되어 있죠. Objective-C 에서 사용하는 데이터 타입과 다르지 않아요. 그래서 json을 object로 매핑해주기 편합니다!</li>
<li><code>xml</code>은 list 타입이 없죠, 같은 depth에 동일한 태그가 여러개 구성되어 있는걸 list라고 판단해야 합니다. 우연히 해당 태그가 1개만 오면 이게 단순 key-value인지 list인지 알 방법이 없죠.</li>
</ul>
<h2 id="XML-파싱하기"><a href="#XML-파싱하기" class="headerlink" title="XML 파싱하기"></a>XML 파싱하기</h2><p>Objective-C 에서는 <code>NSXMLParser</code> 라는 클래스를 제공하여 쉽게 XML을 파싱할 수 있도록 도와주고 있습니다.<br>NSXMLParser로 XML을 파싱하는 순서는 다음과 같습니다.</p>
<ol>
<li>NSXMLParser에 파싱할 XML데이터 주입</li>
<li><code>parse</code> 메소드 호출</li>
<li>NSXMLParser의 델리게이트 호출 (문서 시작, 태그 시작, 태그 끝, 문서 종료 등..)</li>
</ol>
<h2 id="NSXMLParser-Delegate"><a href="#NSXMLParser-Delegate" class="headerlink" title="NSXMLParser Delegate"></a>NSXMLParser Delegate</h2><pre><code class="obj-c">- (void)parserDidStartDocument:(NSXMLParser *)parser {
}
</code></pre>
<p>XML 문서가 시작했음을 알리는 Delegate입니다. 처음 1회만 수행합니다.</p>
<pre><code class="obj-c">- (void)parser:(NSXMLParser *)parser didStartElement:(NSString *)elementName namespaceURI:(NSString *)namespaceURI qualifiedName:(NSString *)qName attributes:(NSDictionary&lt;NSString *,NSString *&gt; *)attributeDict {

}
</code></pre>
<p><code>&lt;태그&gt;</code> 를 발견했을 때 호출됩니다. elementName값으로 <code>태그</code>가 넘어옵니다.<br><code>&lt;태그 속성=값&gt;</code> 의 형식으로 된 XML태그의 경우 attributes dict 파라미터로 @{ @”속성”, @”값” } 이 전달됩니다.</p>
<pre><code class="obj-c">- (void)parser:(NSXMLParser *)parser didEndElement:(NSString *)elementName namespaceURI:(NSString *)namespaceURI qualifiedName:(NSString *)qName {
}
</code></pre>
<p><code>&lt;/태그&gt;</code> 를 발견했을 때 호출됩니다. elementName 값으로 <code>태그</code>가 넘어옵니다.</p>
<pre><code class="obj-c">- (void)parser:(NSXMLParser *)parser foundCharacters:(NSString *)string {
}
</code></pre>
<p>일반 문자열을 발견했을 때 호출됩니다.<br><code>&lt;태그&gt;안녕하세요&lt;/태그&gt;</code> 이 경우에 <code>didStartElement</code> 로 <code>태그</code> 값을 읽은 후 <code>foundCharacters</code> 메소드로 안, 녕, 하, 세, 요 가 한글자씩 전달됩니다.</p>
<pre><code class="obj-c">- (void)parserDidEndDocument:(NSXMLParser *)parser {
}
XML 문서가 끝났을 때 호출됩니다.

</code></pre>
<ul>
<li>5개 Delegate 외에 파싱 에러 등 다른 메소드도 있지만 option으로 꼭 구현이 필요하진 않습니다</li>
</ul>
<h2 id="XML-Parsing-코드"><a href="#XML-Parsing-코드" class="headerlink" title="XML Parsing 코드"></a>XML Parsing 코드</h2><p>선거 정보 API 에서 내려오는 XML 예제는 다음과 같습니다.</p>
<pre><code class="XML">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;response&gt;
    &lt;header&gt;
        &lt;resultCode&gt;INFO-00&lt;/resultCode&gt;
        &lt;resultMsg&gt;NORMAL SERVICE&lt;/resultMsg&gt;
    &lt;/header&gt;
    &lt;body&gt;
        &lt;items&gt;
            &lt;item&gt;
                &lt;num&gt;1&lt;/num&gt;
                &lt;sgId&gt;20180613&lt;/sgId&gt;
                &lt;sgName&gt;제7회 전국동시지방선거&lt;/sgName&gt;
                &lt;sgTypecode&gt;0&lt;/sgTypecode&gt;
                &lt;sgVotedate&gt;20180613&lt;/sgVotedate&gt;
            &lt;/item&gt;
            &lt;item&gt;
                &lt;num&gt;2&lt;/num&gt;
                &lt;sgId&gt;220180613&lt;/sgId&gt;
                &lt;sgName&gt;국회의원선거&lt;/sgName&gt;
                &lt;sgTypecode&gt;2&lt;/sgTypecode&gt;
                &lt;sgVotedate&gt;20180613&lt;/sgVotedate&gt;
            &lt;/item&gt;
        &lt;/items&gt;
        &lt;numOfRows&gt;10&lt;/numOfRows&gt;
        &lt;pageNo&gt;1&lt;/pageNo&gt;
        &lt;totalCount&gt;10&lt;/totalCount&gt;
    &lt;/body&gt;
&lt;/response&gt;
</code></pre>
<ul>
<li>중간에 <code>&lt;item&gt;</code> 이 엄청 많이 나오는데 list를 표현하기위해 2개만 남기고 나머지는 생략처리했습니다.</li>
</ul>
<p>위 XML에 매핑할 Object는 다음과 같이 작성했습니다.</p>
<pre><code class="obj-c">//
//  EHElectionSchedule.h
//  ElectionHelper
//
//  Created by JingyuJung on 2018. 4. 29..
//  Copyright © 2018년 JingyuJung. All rights reserved.
//

#import &lt;Foundation/Foundation.h&gt;


@interface EHElectionSchedule : NSObject

@property (nonatomic, strong) NSNumber *sgId;
@property (nonatomic, strong) NSString *sgName;
@property (nonatomic, strong) NSNumber *sgTypecode;
@property (nonatomic, strong) NSString *sgVotedate;

@end


@interface EHElectionSchedule_XMLArray : NSMutableArray

@end

@interface EHElectionScheduleResponseHeader : NSObject

@property (nonatomic, strong) NSString *resultCode;

@end


@interface EHElectionScheduleItems : NSObject

@property (nonatomic, strong) EHElectionSchedule_XMLArray *item;

@end


@interface EHElectionScheduleResponseBody : NSObject

@property (nonatomic, strong) EHElectionScheduleItems *items;

@end


@interface EHElectionScheduleResponse : NSObject

@property (nonatomic, strong) EHElectionScheduleResponseHeader *header;
@property (nonatomic, strong) EHElectionScheduleResponseBody *body;

@end


@interface EHElectionScheduleResponseContainer : NSObject

@property (nonatomic, strong) EHElectionScheduleResponse *response;

@end
</code></pre>
<p>클래스를 읽는 방향은 아래쪽부터 위로 읽어가면 됩니다.<br>규칙은 다음과 같습니다. </p>
<ul>
<li>클래스는 XML에서 1 Depth를 의미합니다.</li>
<li>프로퍼티명은 XML에서 tag 값과 일치해야 합니다.</li>
<li><code>Array Type</code> 을 표현할 경우 <code>{Array에 담길 클래스}{Array타입임을 알릴 Suffix}</code> 의 클래스를 추가적으로 선언해야 합니다. Suffix에 <code>_XMLArray</code>를 사용한 이유는 Parser코드에서 볼 수 있습니다.</li>
<li>프로퍼티의 클래스 타입은 Custom, NSString, NSNumber 입니다. (Primitive 타입 지원하지 않습니다.. 못합니다 ㅠㅜ)</li>
</ul>
<h2 id="XML-Parser"><a href="#XML-Parser" class="headerlink" title="XML Parser"></a>XML Parser</h2><p>우선 Full Code 입니다.</p>
<pre><code class="obj-c">//
//  EHXMLSerializer.m
//  ElectionHelper
//
//  Created by JingyuJung on 2018. 4. 29..
//  Copyright © 2018년 JingyuJung. All rights reserved.
//

#import &quot;EHXMLSerializer.h&quot;
#import &lt;objc/runtime.h&gt;


@interface EHXMLSerializer ()

@property (nonatomic, strong) NSXMLParser *parser;

@property (nonatomic, strong) NSMutableArray&lt;id&gt; *keyStack;
@property (nonatomic, strong) NSMutableString *value;

@property (nonatomic, strong) Class wrapperClass;
@property (nonatomic, strong) id result;

@end



static NSString *const kEHXMLArraySuffix = @&quot;_XMLArray&quot;;

@implementation EHXMLSerializer

#pragma mark - Constructor
+ (instancetype)serializer {
    static EHXMLSerializer *shared = nil;

    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        shared = [[EHXMLSerializer alloc] init];
        [shared EH_initializeXMLParser];
    });

    return shared;
}

#pragma mark - Public
- (id)modelWithXMLResponse:(NSURLResponse *)response {
    [_parser parse];
    return nil;
}

#pragma mark - Private
- (void)EH_initializeXMLParser {
    _parser = [[NSXMLParser alloc] init];
    _parser.delegate = self;
}

- (id)responseObjectForResponse:(NSURLResponse *)response data:(NSData *)data error:(NSError *__autoreleasing  _Nullable *)error {
    NSError *anError = nil;

    if (![_responseClass isSubclassOfClass:NSData.class]) {
        NSXMLParser *parser = [[NSXMLParser alloc] initWithData:data];
        if (parser &amp;&amp; !anError) {
            if (_responseClass) {
                parser.delegate = self;
                [parser parse];
            }
        }
    }
    return _result;
}

#pragma mark - NSXMLParserDelegate

- (void)parserDidStartDocument:(NSXMLParser *)parser {
    _result = [[_responseClass alloc] init];
    _keyStack = [NSMutableArray array];
    [_keyStack addObject:_result];
}

- (void)parser:(NSXMLParser *)parser didStartElement:(NSString *)elementName namespaceURI:(NSString *)namespaceURI qualifiedName:(NSString *)qName attributes:(NSDictionary&lt;NSString *,NSString *&gt; *)attributeDict {

    NSObject *parentObject = _keyStack.lastObject;
    Class propertyClass = [self EH_classWithParentObject:parentObject propertyName:elementName];

    if (propertyClass) {
        id childObject;
        if (propertyClass == [NSNumber class]) {
            // NSNumber의 경우 init 제공 X =&gt; nil 방지처리
            childObject = [[NSNumber alloc] initWithInt:0];
        } else if ([NSStringFromClass(propertyClass) hasSuffix:kEHXMLArraySuffix]) {
            NSString *elementClassString = [NSStringFromClass(propertyClass) stringByReplacingOccurrencesOfString:kEHXMLArraySuffix withString:@&quot;&quot;];
            NSMutableArray *array = [parentObject valueForKey:elementName];
            if (![array isKindOfClass:[NSArray class]]) {
                [_keyStack addObject:[NSMutableArray array]];
            } else {
                [_keyStack addObject:array];
            }
            propertyClass = NSClassFromString(elementClassString);
            childObject = [[propertyClass alloc] init];
        } else {
            childObject = [[propertyClass alloc] init];
        }
        [_keyStack addObject:childObject];
        _value = [NSMutableString string];
    }
}

- (void)parser:(NSXMLParser *)parser didEndElement:(NSString *)elementName namespaceURI:(NSString *)namespaceURI qualifiedName:(NSString *)qName {

    NSObject *parentObject = [_keyStack objectAtIndex:_keyStack.count - 2];
    NSMutableArray *wrapperArray;
    BOOL isArrayType = [parentObject isKindOfClass:[NSArray class]];
    if (isArrayType) {
        wrapperArray = (NSMutableArray *)parentObject;
        parentObject = [_keyStack objectAtIndex:_keyStack.count - 3];
    }

    Class propertyClass = [self EH_classWithParentObject:parentObject propertyName:elementName];

    if (!propertyClass) {
        return;
    }

    id value = [_value length] ? _value : _keyStack.lastObject;

    if (isArrayType) {
        [(NSMutableArray *)wrapperArray addObject:_keyStack.lastObject];
        [_keyStack removeLastObject];
        value = wrapperArray;
    }

    [parentObject setValue:value forKey:elementName];
    [_keyStack removeLastObject];
    _value = nil;
}

- (void)parser:(NSXMLParser *)parser foundCharacters:(NSString *)string {
    [_value appendString:string];
}

- (void)parserDidEndDocument:(NSXMLParser *)parser {
    _result = _keyStack.firstObject;
}

- (Class)EH_classWithParentObject:(NSObject *)object propertyName:(NSString *)propertyName {

    Class objectClass = object.class;
    Class result;

    unsigned int propertiesCount = 0;
    objc_property_t *properties = class_copyPropertyList(objectClass, &amp;propertiesCount);

    for (int index = 0; index &lt; propertiesCount; index++) {
        objc_property_t property = properties[index];
        const char *cname = property_getName(property);
        NSString *name = [NSString stringWithUTF8String:cname];

        if ([name isEqualToString:propertyName]) {

            const char *type = property_getAttributes(property);
            NSString *typeString = [NSString stringWithUTF8String:type];
            NSArray *attributes = [typeString componentsSeparatedByString:@&quot;,&quot;];
            NSString *typeAttribute = [attributes objectAtIndex:0];
            NSString *propertyType = [typeAttribute substringFromIndex:1];
            NSString *propertyClass = [self EH_removeNotNeededChar:propertyType];

            result = NSClassFromString(propertyClass);
        }
    }

    free(properties);
    return result;
}

- (NSString *)EH_removeNotNeededChar:(NSString *)originString {
    if (originString.length &lt; 3) {
        return nil;
    }
    if ([[originString substringWithRange:NSMakeRange(0, 2)] isEqualToString:@&quot;@\&quot;&quot;] &amp;&amp;
        [[originString substringWithRange:NSMakeRange(originString.length - 1, 1)] isEqualToString:@&quot;\&quot;&quot;]) {
        return [originString substringWithRange:NSMakeRange(2, originString.length - 3)];
    }
    return nil;
}

@end

</code></pre>
<p>이제 구간별로 살펴보겠습니다.</p>
<ul>
<li>라인 : <code>13 - 23</code><br><code>`</code> obj-c<br>@interface EHXMLSerializer ()</li>
</ul>
<p>@property (nonatomic, strong) NSXMLParser *parser;</p>
<p>@property (nonatomic, strong) NSMutableArray<id> <em>keyStack;<br>@property (nonatomic, strong) NSMutableString </em>value;</id></p>
<p>@property (nonatomic, strong) Class wrapperClass;<br>@property (nonatomic, strong) id result;</p>
<p>@end</p>
<pre><code>
parser는 파싱을 수행할 parser
keyStack은 태그를 읽어나가면서 Depth를 관리하기 위한 Stack 입니다
value는 태그의 값을 관리하기 위한 MutableString 입니다
wrapperClass는 array 타입으로 된 부분을 파싱하기 위한 프로퍼티입니다
result는 최종 파싱 결과물이 될 프로퍼티입니다.


* 라인 : `17 - 42`

``` obj-c
static NSString *const kEHXMLArraySuffix = @&quot;_XMLArray&quot;;

@implementation EHXMLSerializer

#pragma mark - Constructor
+ (instancetype)serializer {
    static EHXMLSerializer *shared = nil;

    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        shared = [[EHXMLSerializer alloc] init];
        [shared EH_initializeXMLParser];
    });

    return shared;
}
</code></pre><p><code>@&quot;_XMLArray&quot;</code> 는 해당 클래스가 XML을 파싱할 때 Array 타입으로 해야한다는 걸 알리기 위해 Model 작성할 때 명시적으로 붙였던 Suffix 입니다.<br><code>serialilzer</code> 는 GCD를 이용해 싱글톤으로 구현한 생성자입니다.</p>
<ul>
<li>라인 : <code>56 - 69</code></li>
</ul>
<pre><code class="obj-c">- (id)responseObjectForResponse:(NSURLResponse *)response data:(NSData *)data error:(NSError *__autoreleasing  _Nullable *)error {
    NSError *anError = nil;

    if (![_responseClass isSubclassOfClass:NSData.class]) {
        NSXMLParser *parser = [[NSXMLParser alloc] initWithData:data];
        if (parser &amp;&amp; !anError) {
            if (_responseClass) {
                parser.delegate = self;
                [parser parse];
            }
        }
    }
    return _result;
}
</code></pre>
<p>response 로 받아온 XML Data를 이용해서 외부에서 호출하는 메소드입니다.<br>외부에서 이 메소드를 호출하기 전에 <code>responseClass</code>에 이 XML에 매핑할 클래스를 <code>set</code> 해주는 과정이 꼬오옥 필요합니다.</p>
<pre><code class="obj-c">[[EHXMLSerializer serializer] setResponseClass:[EHElectionScheduleResponseContainer class]];
        EHElectionScheduleResponseContainer *container = [[EHXMLSerializer serializer] responseObjectForResponse:response data:responseObject error:&amp;error];
</code></pre>
<p>API 호출을 완료한 후 Model에 Mapping 하기 위해 Parser호출하는 부분</p>
<p><code>[parser parse]</code>에 의해 파싱이 시작됩니다.</p>
<ul>
<li>라인 : <code>73 - 77</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li>(void)parserDidStartDocument:(NSXMLParser *)parser {<br>  _result = [[_responseClass alloc] init];<br>  _keyStack = [NSMutableArray array];<br>  [_keyStack addObject:_result];<br>}<br><code>`</code><br>XML 문서 파싱을 시작할 때 호출됩니다. 파싱에 필요한 프로퍼티들을 초기화합니다. 가장 첫번째 Response 객체를 keyStack에 담는것으로 파싱을 시작합니다.</li>
</ul>
<ul>
<li>라인 : <code>79 - 105</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li><p>(void)parser:(NSXMLParser <em>)parser didStartElement:(NSString </em>)elementName namespaceURI:(NSString <em>)namespaceURI qualifiedName:(NSString </em>)qName attributes:(NSDictionary<nsstring *,nsstring="" *=""> *)attributeDict {</nsstring></p>
<p>  NSObject *parentObject = _keyStack.lastObject;<br>  Class propertyClass = [self EH_classWithParentObject:parentObject propertyName:elementName];</p>
<p>  if (propertyClass) {</p>
<pre><code>  id childObject;
  if (propertyClass == [NSNumber class]) {
      childObject = [[NSNumber alloc] initWithInt:0];
  } else if ([NSStringFromClass(propertyClass) hasSuffix:kEHXMLArraySuffix]) {
      NSString *elementClassString = [NSStringFromClass(propertyClass) stringByReplacingOccurrencesOfString:kEHXMLArraySuffix withString:@&quot;&quot;];
      NSMutableArray *array = [parentObject valueForKey:elementName];
      if (![array isKindOfClass:[NSArray class]]) {
          [_keyStack addObject:[NSMutableArray array]];
      } else {
          [_keyStack addObject:array];
      }
      propertyClass = NSClassFromString(elementClassString);
      childObject = [[propertyClass alloc] init];
  } else {
      childObject = [[propertyClass alloc] init];
  }
  [_keyStack addObject:childObject];
  _value = [NSMutableString string];
</code></pre><p>  }<br>}<br><code>`</code></p>
</li>
</ul>
<p>XML 에서 태그를 발견하면 keyStack의 lastObject (1 depth 상위 클래스) 에 포함된 프로퍼티인지 확인합니다. 없다면 굳이 매핑이 필요없으므로 패스!<br>포함되어있다면 해당 프로퍼티의 클래스를 판별하고 할당하여 keyStack에 담아둡니다. <code>_value</code> NSMutableString 을 할당하여 값을 읽을 준비를 합니다.</p>
<ul>
<li>라인 : <code>136 - 138</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li>(void)parser:(NSXMLParser <em>)parser foundCharacters:(NSString </em>)string {<br>  [_value appendString:string];<br>}<br><code>`</code></li>
</ul>
<p>태그 사이의 값들을 <code>_value</code> 에  appending해 나가면서 값을 완성시켜 나갑니다.</p>
<ul>
<li>라인 : <code>107 - 134</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li><p>(void)parser:(NSXMLParser <em>)parser didEndElement:(NSString </em>)elementName namespaceURI:(NSString <em>)namespaceURI qualifiedName:(NSString </em>)qName {</p>
<p>  NSObject <em>parentObject = [_keyStack objectAtIndex:_keyStack.count - 2];<br>  NSMutableArray </em>wrapperArray;<br>  BOOL isArrayType = [parentObject isKindOfClass:[NSArray class]];<br>  if (isArrayType) {</p>
<pre><code>  wrapperArray = (NSMutableArray *)parentObject;
  parentObject = [_keyStack objectAtIndex:_keyStack.count - 3];
</code></pre><p>  }</p>
<p>  Class propertyClass = [self EH_classWithParentObject:parentObject propertyName:elementName];</p>
<p>  if (!propertyClass) {</p>
<pre><code>  return;
</code></pre><p>  }</p>
<p>  id value = [_value length] ? _value : _keyStack.lastObject;</p>
<p>  if (isArrayType) {</p>
<pre><code>  [(NSMutableArray *)wrapperArray addObject:_keyStack.lastObject];
  [_keyStack removeLastObject];
  value = wrapperArray;
</code></pre><p>  }</p>
<p>  [parentObject setValue:value forKey:elementName];<br>  [_keyStack removeLastObject];<br>  _value = nil;<br>}<br><code>`</code><br>태그가 끝나면 keyStack의 마지막 object에 값을 KVC로 셋하고 _keyStack에서 완성된 lastObject를 제거합니다.<br>만약 부모클래스가 Array 타입이었다면 현재 완성된 클래스를 Array에 추가시켜줍니다.</p>
</li>
</ul>
<ul>
<li>라인 : <code>140 - 142</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li>(void)parserDidEndDocument:(NSXMLParser *)parser {<br>  _result = _keyStack.firstObject;<br>}<br><code>`</code><br>XML 문서가 끝나면 최종적으로 keyStack에는 최상위 클래스가 남게됩니다. 따라서 result에 _keyStack의 firstObject를 연결합니다.</li>
</ul>
<ul>
<li>라인 : <code>144 - 172</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li><p>(Class)EH_classWithParentObject:(NSObject <em>)object propertyName:(NSString </em>)propertyName {</p>
<p>  Class objectClass = object.class;<br>  Class result;</p>
<p>  unsigned int propertiesCount = 0;<br>  objc_property_t *properties = class_copyPropertyList(objectClass, &amp;propertiesCount);</p>
<p>  for (int index = 0; index &lt; propertiesCount; index++) {</p>
<pre><code>  objc_property_t property = properties[index];
  const char *cname = property_getName(property);
  NSString *name = [NSString stringWithUTF8String:cname];

  if ([name isEqualToString:propertyName]) {

      const char *type = property_getAttributes(property);
      NSString *typeString = [NSString stringWithUTF8String:type];
      NSArray *attributes = [typeString componentsSeparatedByString:@&quot;,&quot;];
      NSString *typeAttribute = [attributes objectAtIndex:0];
      NSString *propertyType = [typeAttribute substringFromIndex:1];
      NSString *propertyClass = [self EH_removeNotNeededChar:propertyType];

      result = NSClassFromString(propertyClass);
  }
</code></pre><p>  }</p>
<p>  free(properties);<br>  return result;<br>}<br><code>`</code></p>
</li>
</ul>
<p>해당 obejct에 propertyName이라는 변수명을 가진 프로퍼티의 클래스를 리턴해주는 함수입니다.<br>Objective-C의 인스트로펙션, 자바에서 리플렉션이라 불리는 기능을 이용해 구현합니다.</p>
<ul>
<li>라인 : <code>174 - 183</code><br><code>`</code> obj-c</li>
</ul>
<ul>
<li>(NSString <em>)EH_removeNotNeededChar:(NSString </em>)originString {<br>  if (originString.length &lt; 3) {<pre><code>  return nil;
</code></pre>  }<br>  if ([[originString substringWithRange:NSMakeRange(0, 2)] isEqualToString:@”@\””] &amp;&amp;<pre><code>  [[originString substringWithRange:NSMakeRange(originString.length - 1, 1)] isEqualToString:@&quot;\&quot;&quot;]) {
  return [originString substringWithRange:NSMakeRange(2, originString.length - 3)];
</code></pre>  }<br>  return nil;<br>}<br><code>`</code></li>
</ul>
<p>runtime 메소드를 이용해 property의 클래스 타입을 가져왔을 때, @\”\” 의 불필요한 문자열이 추가되기 때문에 제거를 위해 만든 함수입니다.</p>
<h2 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h2><p>위에서 만든 XMl Serializer를 이용해 XML을 매핑하면 다음과 같은 결과를 얻을 수 있습니다.<br><img src="../../../../images/xmlparser/1.png" alt=""></p>
<p><code>더 보완이 필요한 내용</code></p>
<ul>
<li>현재 최종 마지막 타입은 <code>NSString</code> 과 <code>NSNumber</code> 만 지원하고 있는데, <code>NSDate</code> 도 추가가 필요합니다!</li>
</ul>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>Jingyu Jung</p>
                    <span>iOS Engineer 정진규</span>
                    <dl>
                        <dd><a href="https://monibu1548.github.io" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">48 <p>Articles</p></a></li>
                    <li><a href="/categories">11 <p>Categories</p></a></li>
                    <li><a href="/tags">55 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#공공데이터-Open-API"><span class="toc-number">1.</span> <span class="toc-text">공공데이터 Open API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#지방선거-API-활용하기"><span class="toc-number">2.</span> <span class="toc-text">지방선거 API 활용하기</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML-파싱하기"><span class="toc-number">3.</span> <span class="toc-text">XML 파싱하기</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSXMLParser-Delegate"><span class="toc-number">4.</span> <span class="toc-text">NSXMLParser Delegate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML-Parsing-코드"><span class="toc-number">5.</span> <span class="toc-text">XML Parsing 코드</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML-Parser"><span class="toc-number">6.</span> <span class="toc-text">XML Parser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#결과"><span class="toc-number">7.</span> <span class="toc-text">결과</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>

    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2019
        <span class="gradient-text">
            Jingyu Jung
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script>
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/swift/swift.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>



    <script src="/js/busuanzi.min.js"></script>
    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>


<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-117570529-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-117570529-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["iOS Engineer 정진규", ""],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
