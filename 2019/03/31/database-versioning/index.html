<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="u1mTB5JWczvR8aazOKgWjreaUB1ssIwuGy2FtZnfj68"><title> [iOS] SQLite3 Database 스키마 버전 관리의 필요성 및 방법 소개 · JingyuJung's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="[iOS] SQLite3 Database 스키마 버전 관리의 필요성 및 방법 소개 - Jingyu Jung"><meta name="keywords"><meta name="author" content="Jingyu Jung"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://monibu1548.github.io/atom.xml" title="JingyuJung's Blog"><script aync src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="POSTS" class="nav-list-link">POSTS</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="ARCHIVES" class="nav-list-link">ARCHIVES</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><ins style="display:block" data-ad-client="ca-pub-1405208574064220" data-ad-slot="7872165136" data-ad-format="auto" class="adsbygoogle"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({})</script><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">[iOS] SQLite3 Database 스키마 버전 관리의 필요성 및 방법 소개</h1><div class="post-info">2019-03-31<p class="visit"><i data-hk-page="current">-</i><span>읽음</span></p></div><div class="post-content"><h2 id="Database-SQLite3에-스키마-버전관리가-필요한-이유"><a href="#Database-SQLite3에-스키마-버전관리가-필요한-이유" class="headerlink" title="Database SQLite3에 스키마 버전관리가 필요한 이유"></a>Database SQLite3에 스키마 버전관리가 필요한 이유</h2><p>앱에 신규 기능을 추가하다 보면 Database(SQLite3) 스키마에 변경이 필요한 경우가 생깁니다. 예를 들면, 현재 토이 프로젝트 “퇴근요정” 은 아래와 같은 테이블을 갖고 있습니다.</p>
<p><img src="../../../../images/sqlite3-versioning/1.png" alt=""></p>
<p>각 근무시간의 PK인 id, 근무 시작시간 start, 근무 종료시간 end, 이렇게 3개의 column을 갖고 있습니다.</p>
<p>이번 v1.7 에서는 각 근무에 대한 특이사항 및 근무지 등 사용자가 다양하게 사용할 수 있도록 하기위해 <code>메모</code> 기능을 추가 예정입니다. 따라서 새로운 테이블은 아래와 갖은 구조를 가져야 합니다.</p>
<p><img src="../../../../images/sqlite3-versioning/2.png" alt=""></p>
<h2 id="생각만큼-구현이-쉽지-않다"><a href="#생각만큼-구현이-쉽지-않다" class="headerlink" title="생각만큼 구현이 쉽지 않다"></a>생각만큼 구현이 쉽지 않다</h2><p>앱이 실행되고 Database를 관리하는 Singleton의 객체가 초기화 될 때 DB를 초기화하고 Table이 없으면 새로 생성하는 로직은 이미 기존 코드에서 갖고 있습니다.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> sqlite3_exec(db, <span class="string">"CREATE TABLE IF NOT EXISTS WorkingTimes (id INTEGER PRIMARY KEY AUTOINCREMENT, start INTEGER, end INTEGER)"</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>) != <span class="type">SQLITE_OK</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> errmsg = <span class="type">String</span>(cString: sqlite3_errmsg(db)!)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"error creating table: \(errmsg)"</span>)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>Table을 생성하는 SQL문<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> WorkingTimes (<span class="keyword">id</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT, <span class="keyword">start</span> <span class="built_in">INTEGER</span>, <span class="keyword">end</span> <span class="built_in">INTEGER</span></span><br></pre></td></tr></table></figure></p>
<p>를 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> WorkingTimes (<span class="keyword">id</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT, <span class="keyword">start</span> <span class="built_in">INTEGER</span>, <span class="keyword">end</span> <span class="built_in">INTEGER</span>, memo <span class="built_in">TEXT</span></span><br></pre></td></tr></table></figure>
<p>로 변경하면 쉽게 끝날 것 같지만, 큰 문제가 발생합니다.</p>
<p>앱을 처음 설치하는 유저의 경우 Table이 정상적으로 생성되고 앱 사용에 문제가 없지만, 기존 v1.6을 사용하던 유저들은 <code>memo</code> Column 이 없는 WorkingTime Table을 사용하게 되므로 UI상에서는 메모를 입력하고 수정하고 저장하지만, 저장도, 불러올 수도 없는 문제가 생깁니다.</p>
<p>앱 버전관리와 마찬가지로 DB도 버전관리가 필요함을 알 수 있습니다. 앱 버전관리에 대한 필요성은 <a href="http://monibu1548.github.io/2018/05/19/remote-config-forced-update/">iOS 앱 업데이트 (강제 업데이트, 선택 업데이트) 기능 구현 예제</a> 에서 포스팅했습니다.</p>
<h2 id="SQlite3-스키마-버전관리-방법"><a href="#SQlite3-스키마-버전관리-방법" class="headerlink" title="SQlite3 스키마 버전관리 방법"></a>SQlite3 스키마 버전관리 방법</h2><p>버전관리를 하기 위해서는 3가지를 인지하고 있어야 합니다.</p>
<ol>
<li>현재 버전</li>
<li>최신 버전</li>
<li>마이그레이션 방법</li>
</ol>
<p>따라서 버전관리를 구현함에 있어서 스키마 버전을 관리할 수 있도록 UserDefault를 사용하게 되며 DB 초기화 로직에서 버전에 따라 마이그레이션을 진행하면 됩니다.</p>
<h3 id="DB-버전-관리"><a href="#DB-버전-관리" class="headerlink" title="DB 버전 관리"></a>DB 버전 관리</h3><p>UserDefaultManager 에 아래 메소드를 추가합니다.<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">databaseSchemaVersion</span><span class="params">()</span></span> -&gt; <span class="type">NSInteger</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">UserDefaults</span>.standard.integer(forKey: <span class="string">"databaseSchemaVersion"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">setDatabaseSchemaVersion</span><span class="params">(version: NSInteger)</span></span> &#123;</span><br><span class="line">    <span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(version, forKey: <span class="string">"databaseSchemaVersion"</span>)</span><br></pre></td></tr></table></figure></p>
<p>이전 버전에서는 “databaseSchemaVersion” 을 key로 Set된 데이터가 없기 때문에 기존의 스키마를 0으로 사용할 수 있습니다.</p>
<h3 id="DB-초기화"><a href="#DB-초기화" class="headerlink" title="DB 초기화"></a>DB 초기화</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">initialize</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> databaseSchemaVersion = <span class="type">UserDefaultManager</span>.databaseSchemaVersion()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... 생략</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> sqlite3_exec(db, <span class="string">"CREATE TABLE IF NOT EXISTS WorkingTimes (id INTEGER PRIMARY KEY AUTOINCREMENT, start INTEGER, end INTEGER, memo TEXT)"</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>) != <span class="type">SQLITE_OK</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> errmsg = <span class="type">String</span>(cString: sqlite3_errmsg(db)!)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"error creating table: \(errmsg)"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">UserDefaultManager</span>.setDatabaseSchemaVersion(version: <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... 생략</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>신규 유저를 위해 WorkingTime Table을 생성하는 Query를 업데이트 하며 정상적으로 Table이 생성되면 UserDefaultManager를 통해 현재 DB Schema 버전을 1로 저장합니다.</p>
<h3 id="마이그레이션"><a href="#마이그레이션" class="headerlink" title="마이그레이션"></a>마이그레이션</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public func initialize() &#123;</span><br><span class="line">        let databaseSchemaVersion = UserDefaultManager.databaseSchemaVersion()</span><br><span class="line">        </span><br><span class="line">        // ... 생략</span><br><span class="line">        </span><br><span class="line">        if (databaseSchemaVersion == 0) &#123;</span><br><span class="line">            if sqlite3_exec(db, &quot;ALTER TABLE WorkingTimes ADD COLUMN memo TEXT;&quot;, nil, nil, nil) == SQLITE_OK &#123;</span><br><span class="line">                UserDefaultManager.setDatabaseSchemaVersion(version: 1)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>DB초기화 시점에서 현재 SchemaVersion을 확인하여 최신(1)이 아닌 (0)인 경우에 최신버전의 Schema로 맞춰주기 위해 <code>ADD COLUMN</code> Query를 실행합니다. 경우에 따라서는 더 복잡한 코드도 필요할 수 있습니다.</p>
<h2 id="한계점"><a href="#한계점" class="headerlink" title="한계점"></a>한계점</h2><p>결국 마이그레이션 코드는 레거시로 남게 됩니다. 새로운 스키마가 나올때마다 기존 유저들 대응을 위한 마이그레이션 코드가 지속적으로 추가되어야만 하는 한계가 있습니다.</p>
<h2 id="한계-대응"><a href="#한계-대응" class="headerlink" title="한계 대응"></a>한계 대응</h2><p>그럼 위에서 설명한 한계를 극복하기 위해서는 어떤 방법이 있을까요. <code>지표 수집</code>을 통해서 현재 사용자들의 어떤 버전의 앱들을 주로 사용하고 있는지 확인하며 사용자가 적은 버전은 강제 업데이트 최소 지원 버전 제한 정책을 통해 제한합니다. 앱 버전을 제한하게 되면 해당 버전에서 사용하던 과거 스키마 버전의 마이그레이션 코드는 지울 수 있게 됩니다.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>카테고리</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NHN-ent/">NHN ent.</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Framework/">Spring Framework</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">36</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Firebase/">Firebase</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Objective-C/">Objective-C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/RxSwift/">RxSwift</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Swift/">Swift</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/XCodeServer/">XCodeServer</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/공통/">공통</a><span class="category-list-count">20</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/띵킹노트/">띵킹노트</a><span class="category-list-count">2</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>태그</h4><a href="/tags/Admob/" style="font-size: 10px;">Admob</a> <a href="/tags/Apple/" style="font-size: 12px;">Apple</a> <a href="/tags/AutoLayout/" style="font-size: 10px;">AutoLayout</a> <a href="/tags/BestPractice/" style="font-size: 10px;">BestPractice</a> <a href="/tags/CI/" style="font-size: 10px;">CI</a> <a href="/tags/CocoaPods/" style="font-size: 12px;">CocoaPods</a> <a href="/tags/Database/" style="font-size: 10px;">Database</a> <a href="/tags/Dooray/" style="font-size: 10px;">Dooray</a> <a href="/tags/Firebase/" style="font-size: 16px;">Firebase</a> <a href="/tags/GCD/" style="font-size: 10px;">GCD</a> <a href="/tags/HitTest/" style="font-size: 10px;">HitTest</a> <a href="/tags/Interface-Builder/" style="font-size: 10px;">Interface Builder</a> <a href="/tags/Jasypt/" style="font-size: 10px;">Jasypt</a> <a href="/tags/NHN/" style="font-size: 12px;">NHN</a> <a href="/tags/NSXMLParser/" style="font-size: 10px;">NSXMLParser</a> <a href="/tags/Reflection/" style="font-size: 12px;">Reflection</a> <a href="/tags/RemoteConfig/" style="font-size: 10px;">RemoteConfig</a> <a href="/tags/Runtime/" style="font-size: 10px;">Runtime</a> <a href="/tags/RxSwift/" style="font-size: 14px;">RxSwift</a> <a href="/tags/SQLite3/" style="font-size: 10px;">SQLite3</a> <a href="/tags/Spring-Framework/" style="font-size: 18px;">Spring Framework</a> <a href="/tags/Storyboard/" style="font-size: 10px;">Storyboard</a> <a href="/tags/Swift/" style="font-size: 14px;">Swift</a> <a href="/tags/Web/" style="font-size: 16px;">Web</a> <a href="/tags/XCode/" style="font-size: 12px;">XCode</a> <a href="/tags/XCodeServer/" style="font-size: 12px;">XCodeServer</a> <a href="/tags/XML-Parser/" style="font-size: 10px;">XML Parser</a> <a href="/tags/Xcode/" style="font-size: 12px;">Xcode</a> <a href="/tags/grafana/" style="font-size: 10px;">grafana</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/influxDB/" style="font-size: 10px;">influxDB</a> <a href="/tags/java/" style="font-size: 12px;">java</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/구글-애널리틱스/" style="font-size: 10px;">구글 애널리틱스</a> <a href="/tags/기술교육/" style="font-size: 10px;">기술교육</a> <a href="/tags/띵킹노트/" style="font-size: 12px;">띵킹노트</a> <a href="/tags/모니터링/" style="font-size: 10px;">모니터링</a> <a href="/tags/배포/" style="font-size: 10px;">배포</a> <a href="/tags/버전-관리/" style="font-size: 10px;">버전 관리</a> <a href="/tags/생산성/" style="font-size: 12px;">생산성</a> <a href="/tags/성능-튜닝/" style="font-size: 10px;">성능 튜닝</a> <a href="/tags/스위프트/" style="font-size: 14px;">스위프트</a> <a href="/tags/스터디/" style="font-size: 10px;">스터디</a> <a href="/tags/스프링-프레임워크/" style="font-size: 18px;">스프링 프레임워크</a> <a href="/tags/심화/" style="font-size: 14px;">심화</a> <a href="/tags/애드몹/" style="font-size: 10px;">애드몹</a> <a href="/tags/앱-고도화/" style="font-size: 14px;">앱 고도화</a> <a href="/tags/업데이트/" style="font-size: 10px;">업데이트</a> <a href="/tags/오토레이아웃/" style="font-size: 10px;">오토레이아웃</a> <a href="/tags/웹/" style="font-size: 16px;">웹</a> <a href="/tags/지표수집/" style="font-size: 10px;">지표수집</a> <a href="/tags/최적화/" style="font-size: 12px;">최적화</a> <a href="/tags/쿼리스트링/" style="font-size: 10px;">쿼리스트링</a> <a href="/tags/토스트루키/" style="font-size: 10px;">토스트루키</a></div></div><div class="widget"><div class="recent"><h4>최근 포스트</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/18/signin-apple/">애플로그인 구현하기 (Firebase와 Apple Sign with Apple)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/17/darkmode/">iOS13 다크모드를 지원하는 앱 개발하기 (How to support dark mode)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/17/wkwebview-memory-leak/">wkwebview message handler memory leak(쉽게 실수하는 WKWebView 메모리 누수 수정)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/06/ios-http-status-code/">[iOS] iOS개발 시 주의해야 할 http status code (클라이언트 개발자도 http를 잘 알아야한다)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/31/database-versioning/">[iOS] SQLite3 Database 스키마 버전 관리의 필요성 및 방법 소개</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">검색</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2019/10/06/ios-http-status-code/" class="prev">PREV</a><a href="/2019/02/09/hittest/" class="next">NEXT</a></div><ins style="display:block" data-ad-client="ca-pub-1405208574064220" data-ad-slot="8456857214" data-ad-format="auto" class="adsbygoogle"></ins><!-- Google Adsense--><script>(adsbygoogle = window.adsbygoogle || []).push({})</script><div id="disqus_thread"></div><script>var disqus_shortname = 'jingyujung';
var disqus_identifier = '2019/03/31/database-versioning/';
var disqus_title = '[iOS] SQLite3 Database 스키마 버전 관리의 필요성 및 방법 소개';
var disqus_url = 'http://monibu1548.github.io/2019/03/31/database-versioning/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//jingyujung.disqus.com/count.js" async></script><!-- 푸터 광고 --><ins style="display:block" data-ad-client="ca-pub-1405208574064220" data-ad-slot="1718675585" data-ad-format="auto" class="adsbygoogle"></ins><!-- Google Adsense--><script>(adsbygoogle = window.adsbygoogle || []).push({})</script><div class="copyright"><p>© 2017 - 2019 <a target="_blank">Jingyu Jung</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-117570529-1",'auto');ga('send','pageview');</script></body></html>